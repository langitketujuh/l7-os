#!/bin/sh

set -eu

ARCH=$(uname -m)
IMAGES="base kde-home kde-studio kde-dev sway-home sway-studio sway-dev"
REPO=
DATE=$(date +%Y%m%d)
GEN=$(pwgen -sA 7 1)

PKGS_KDE="$(grep '^[^#].' pkg/kde.txt | xargs)"
PKGS_SWAY="$(grep '^[^#].' pkg/sway.txt | xargs)"

PKGS_HOME="$(grep '^[^#].' pkg/home.txt | xargs)"
PKGS_STUDIO="$(grep '^[^#].' pkg/studio.txt | xargs)"
PKGS_DEV="$(grep '^[^#].' pkg/dev.txt | xargs)"
PKGS_GLIBC="cnijfilter2"

PKGS_KDE_HOME="$PKGS_HOME $PKGS_KDE"
PKGS_KDE_STUDIO="$PKGS_HOME $PKGS_KDE $PKGS_STUDIO"
PKGS_KDE_DEV="$PKGS_HOME $PKGS_KDE $PKGS_DEV"
PKGS_SWAY_HOME="$PKGS_HOME $PKGS_SWAY"
PKGS_SWAY_STUDIO="$PKGS_HOME $PKGS_SWAY $PKGS_STUDIO"
PKGS_SWAY_DEV="$PKGS_HOME $PKGS_SWAY $PKGS_DEV"

help() {
    echo "${0#/*}: [-a arch] [-b base|kde-home|kde-studio|kde-dev|sway-home|sway-studio|sway-dev] [-r repo]" >&2
}

while getopts "a:b:hr:" opt; do
case $opt in
    a) ARCH="$OPTARG";;
    b) IMAGES="$OPTARG";;
    h) help; exit 0;;
    r) REPO="-r $OPTARG $REPO";;
    *) help; exit 1;;
esac
done
shift $((OPTIND - 1))

build_variant() {
    variant="$1"
    shift
    IMG=langitketujuh-${variant}-${ARCH}-${DATE}-${GEN}.iso
    SERVICES="dbus backlight bluetoothd bluez-alsa cupsd colord earlyoom ntpd ufw uuidd zramen"

    case $variant in
        base)
            GRUB_PKGS="grub-i386-efi grub-x86_64-efi"
            PKGS="dialog cryptsetup lvm2 mdadm xtools-minimal dbus-elogind util-linux $GRUB_PKGS"
            SERVICES="dhcpcd wpa_supplicant acpid dbus uuidd"
        ;;
        kde-home)
            if [ $ARCH = x86_64 ]; then
                PKGS="$PKGS_KDE_HOME $PKGS_GLIBC"
            else
                PKGS="$PKGS_KDE_HOME"
            fi
            SERVICES="$SERVICES NetworkManager sddm"
        ;;
        kde-studio)
            if [ $ARCH = x86_64 ]; then
                PKGS="$PKGS_KDE_STUDIO $PKGS_GLIBC"
            else
                PKGS="$PKGS_KDE_STUDIO"
            fi
            SERVICES="$SERVICES NetworkManager sddm"
        ;;
        kde-dev)
            if [ $ARCH = x86_64 ]; then
                PKGS="$PKGS_KDE_DEV $PKGS_GLIBC arduino dbeaver eclipse plplot-lua plplot-python3"
            else
                PKGS="$PKGS_KDE_DEV"
            fi
            SERVICES="$SERVICES NetworkManager sddm"
        ;;
        sway-home)
            if [ $ARCH = x86_64 ]; then
                PKGS="$PKGS_SWAY_HOME $PKGS_GLIBC"
            else
                PKGS="$PKGS_SWAY_HOME"
            fi
            SERVICES="$SERVICES iwd greetd"
        ;;
        sway-studio)
            if [ $ARCH = x86_64 ]; then
                PKGS="$PKGS_SWAY_STUDIO $PKGS_GLIBC"
            else
                PKGS="$PKGS_SWAY_STUDIO"
            fi
            SERVICES="$SERVICES iwd greetd"
        ;;
        sway-dev)
            if [ $ARCH = x86_64 ]; then
                PKGS="$PKGS_SWAY_DEV $PKGS_GLIBC"
            else
                PKGS="$PKGS_SWAY_DEV"
            fi
            SERVICES="$SERVICES iwd greetd"
        ;;
        *)
            >&2 echo "Unknown variant $variant"
            exit 1
        ;;
    esac

    ./mklive.sh -a "$ARCH" -o "$IMG" -p "$PKGS" -S "$SERVICES" ${REPO} "$@"
}

if [ ! -x mklive.sh ]; then
    echo mklive.sh not found >&2
    exit 1
fi

for image in $IMAGES; do
    build_variant "$image" "$@"
done
