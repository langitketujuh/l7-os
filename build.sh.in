#!/usr/bin/env sh
#-
# Copyright (c) 2020-2021 Hervy Qurrotul Ainur Rozi <hervyqa@pm.me>.
#
# All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
#
# THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
# IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
# OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
# IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
# INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
# NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
# DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
# THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
# (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
# THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#-

# Make sure we don't inherit these from env.
# last update upstream= 25ddad302de250a64336f83499d48dcb4f9570ba

ARCH=
IMAGE=

while getopts "a:b:hr:" opt; do
case $opt in
	a) ARCH="$OPTARG";;
	b) IMAGE="$OPTARG";;
	h) echo "${0#/*}: [-a x86_64|x86_64-musl] [-b base|lite|pro] [-r repo]" >&2; exit 1;;
	r) REPO="-r $OPTARG $REPO";;
esac
done
shift $((OPTIND - 1))

: ${ARCH:=$(uname -m)}

readonly DATE=$(date +%Y%m%d)
readonly GEN=$(pwgen -sA 7 1)
readonly BASE_IMG=langitketujuh-base-${ARCH}-${DATE}-${GEN}.iso
readonly LITE_IMG=langitketujuh-lite-${ARCH}-${DATE}-${GEN}.iso
readonly PRO_IMG=langitketujuh-pro-${ARCH}-${DATE}-${GEN}.iso

readonly NONFREE_REPO_PKGS="void-repo-nonfree"
readonly GRUB_PKGS="grub-i386-efi grub-x86_64-efi"
readonly BASE_PKGS="base-system dialog cryptsetup lvm2 mdadm"
readonly INITRD_PKGS="dracut dracut-uefi dracut-network"
readonly NETWORK_PKGS="inetutils usbutils wget curl dhcpcd wpa_supplicant NetworkManager openntpd"
readonly FIRMWARE_PKGS="linux-firmware linux-firmware-intel linux-firmware-amd linux-firmware-nvidia linux-firmware-network linux-firmware-broadcom broadcom-bt-firmware b43-fwcutter alsa-firmware wifi-firmware dkms intel-media-driver"
readonly XORG_PKGS="xorg xf86-input-evdev xf86-input-joystick xf86-input-libinput xf86-input-mtrack xf86-input-synaptics xf86-input-vmmouse xf86-input-wacom xorg-minimal xorg-input-drivers xorg-video-drivers mesa-ati-dri mesa-intel-dri mesa-nouveau-dri intel-video-accel"
readonly UTILITY_PKGS="setxkbmap xauth xrandr libvdpau-va-gl vdpauinfo font-misc-misc testdisk gptfdisk xclip xclipboard wl-clipboard yank git subversion inxi xtools vsv vim bootiso bc mtools tmate pwgen fish-shell acpilight android-udev-rules android-tools nano zenity librsvg-utils ImageMagick libwebp libwebp-tools bash-completion htop vpsm ufw vim-huge zramen ffmpegthumbnailer ffmpegthumbs media-player-info fprintd earlyoom"
readonly AUDIO_PKGS="alsa-plugins-pulseaudio pipewire gstreamer1-pipewire alsa-utils paprefs bluez-alsa"
readonly CODEC_PKGS="gst-plugins-base1 gst-plugins-good1 gst-plugins-ugly1 gst-plugins-bad1 gst-libav ffmpeg faac faad2 flac jasper lame libdca libmpeg2 libmad libtheora libvorbis libXv wavpack x264 xvidcore gstreamer-vaapi alsa-plugins-ffmpeg"
readonly COMPRESSOR_PKGS="atool p7zip zip unzip lzop lzip dtrx file-roller liblz4 lz4 zlib bzip2 xz"
readonly FS_PKGS="exfat-utils fuse-exfat gvfs-afc gvfs-mtp gvfs-smb udisks2 ntfs-3g"
readonly AUTH_PKGS="elogind dbus-elogind dbus-elogind-x11 gnome-keyring"
readonly PRINTER_PKGS="bluez-cups cups cups-pdf cups-filters gutenprint system-config-printer system-config-printer-udev hplip epson-inkjet-printer-escpr foomatic-db brother-brlaser"
readonly KDE_PKGS="xdg-utils xdg-desktop-portal xdg-desktop-portal-gtk xdg-desktop-portal-kde xdg-user-dirs xdg-user-dirs-gtk libappindicator AppStream sddm kde5 kdesu kde5-baseapps kaccounts-integration kaccounts-providers konsole dolphin dolphin-plugins kimageformats plasma-browser-integration plasma-disks plasma-nm plasma-pa colord-gtk colord-kde kio-extras kio-gdrive kcm-wacomtablet plasma-wayland-protocols kdegraphics-thumbnailers ksuperkey kidentitymanagement plasma-firewall subversion-kwallet-auth user-manager bup kup"
readonly KDE_APPS_PKGS="kdeconnect print-manager spectacle ark k3b kwalletmanager kcalc kget ktorrent okular ssr kcolorchooser kmediaplayer elisa kolourpaint gwenview krfb krdc partitionmanager skanlite krename vlc"
readonly FONTS_PKGS="terminus-font dejavu-fonts-ttf xorg-fonts noto-fonts-emoji liberation-fonts-ttf unicode-character-database unicode-emoji font-awesome5 ttf-material-icons font-ionicons-ttf"
readonly POWERMGMT_PKGS="upower acpi acpi_call-dkms cpufrequtils"
readonly PKGMGMT_PKGS="topgrade flatpak"
readonly BROWSER_PKGS="firefox geckodriver"
readonly VECTOR_PKGS="inkscape"
readonly RASTER_PKGS="gimp"
readonly BRIGHTNESS_PKGS="brightnessctl"
readonly OFFICE_PKGS="libreoffice libreoffice-kde"
readonly APPEARANCE_PKGS="papirus-folders papirus-icon-theme"

readonly MUSL_PKGS="gcompat"
readonly GLIBC_PKGS="glibc-locales"

# PRO Edition
readonly CALLIBRATION_PKGS="lcms lcms2 python-dbus dispcalGUI"
readonly PLUGINS_PKGS="gmic gmic-gimp gimp-lqr-plugin xsane-gimp resynthesizer"
readonly PHOTOGRAPHY_PKGS="digikam rawtherapee hugin Converseen"
readonly VIDEO_EDITOR_PKGS="kdenlive"
readonly FONT_MAKER_PKGS="fontforge"
readonly PAINTING_PKGS="krita"
readonly RECORD_PKGS="obs"
readonly PUBLISH_PKGS="scribus"
readonly ANIMATION_PKGS="blender synfigstudio opentoonz"
readonly AUDIO_PRO_PKGS="jack jack_capture sox audacity ardour kid3 soundkonverter"
readonly FONTS_EXTRA_PKGS="google-fonts-ttf"
readonly GAME_PKGS="godot"
readonly COMPILER_PKGS="automake binutils bison fakeroot flex gcc libtool m4 make patch pkg-config qemu-user-static scons yasm pkgconf libXcursor libXinerama libXi libXrandr libgudev gcc-objc++ xorgproto libfreeglut llvm clang icu cmake"
#readonly CAD_PKGS_PKGS="freecad"
#readonly GAME_WIN_PKGS="cross-x86_64-w64-mingw32 cross-i686-w64-mingw32 python3-pip"
#readonly GAME_APK_PKGS="gradle android-tools openjdk"
#remove="kmail kontact akregator korganizer filelight konversation ytop gnome-color-manager ddgtk vte3"

readonly LITE_PKGS="$NONFREE_REPO_PKGS $GRUB_PKGS $BASE_PKGS $INITRD_PKGS $NETWORK_PKGS $FIRMWARE_PKGS $XORG_PKGS $UTILITY_PKGS $AUDIO_PKGS $CODEC_PKGS $COMPRESSOR_PKGS $FS_PKGS $AUTH_PKGS $PRINTER_PKGS $KDE_PKGS $KDE_APPS_PKGS $FONTS_PKGS $POWERMGMT_PKGS $BROWSER_PKGS $VECTOR_PKGS $RASTER_PKGS $BRIGHTNESS_PKGS $OFFICE_PKGS $APPEARANCE_PKGS"
readonly PRO_PKGS="$LITE_PKGS $CALLIBRATION_PKGS $PLUGINS_PKGS $PHOTOGRAPHY_PKGS $VIDEO_EDITOR_PKGS $FONT_MAKER_PKGS $PAINTING_PKGS $RECORD_PKGS $PUBLISH_PKGS $ANIMATION_PKGS $AUDIO_PRO_PKGS $FONTS_EXTRA_PKGS $CAD_PKGS $GAME_PKGS $COMPILER_PKGS $GAME_WIN_PKGS $GAME_APK_PKGS"

readonly L7_PKGS="l7-ark l7-baloo5 l7-breeze l7-breeze-gtk l7-breeze-icons l7-desktop-file-utils l7-export l7-fish-shell l7-gimp l7-gwenview l7-kate5 l7-kcmutils l7-konsole l7-kscreenlocker l7-libreoffice l7-plasma-desktop l7-removed-packages l7-repo l7-runit-void l7-sddm l7-shadow l7-systemsettings l7-tools"
readonly L7PRO_PKGS="$L7_PKGS l7-ardour l7-audacity l7-godot l7-krita l7-obs l7-scribus"

[ ! -x mklive.sh ] && exit 0

if [ -z "$IMAGE" -o "$IMAGE" = base ]; then
  if [ ! -e $BASE_IMG ]; then
    sh mklive.sh \
    -a $ARCH \
    -o $BASE_IMG \
    -p "$BASE_PKGS" \
    ${REPO} "$@"
  fi
fi

if [ -z "$IMAGE" -o "$IMAGE" = lite ]; then
  if [ -z "$ARCH" -o "$ARCH" = x86_64 ]; then
    if [ ! -e $LITE_IMG ]; then
      sh mklive.sh \
      -a $ARCH \
      -o $LITE_IMG \
      -p "$LITE_PKGS $GLIBC_PKGS" \
      -P "$L7_PKGS" \
      -c /var/cache/xbps/
      ${REPO} "$@"
      echo "\033[1;33mFinish\033[0m"
    fi
  elif [ -z "$ARCH" -o "$ARCH" = x86_64-musl ]; then
    if [ ! -e $LITE_IMG ]; then
      sh mklive.sh \
      -a $ARCH \
      -o $LITE_IMG \
      -p "$LITE_PKGS $MUSL_PKGS" \
      -P "$L7_PKGS" \
      -c /var/cache/xbps/
      ${REPO} "$@"
      echo "\033[1;33mFinish\033[0m"
    fi
  fi
fi

if [ -z "$IMAGE" -o "$IMAGE" = pro ]; then
  if [ -z "$ARCH" -o "$ARCH" = x86_64 ]; then
    if [ ! -e $PRO_IMG ]; then
      sh mklive.sh \
      -a $ARCH \
      -o $PRO_IMG \
      -p "$PRO_PKGS $GLIBC_PKGS" \
      -P "$L7PRO_PKGS" \
      -c /var/cache/xbps/
      ${REPO} "$@"
      echo "\033[1;33mFinish\033[0m"
    fi
  elif [ -z "$ARCH" -o "$ARCH" = x86_64-musl ]; then
    if [ ! -e $PRO_IMG ]; then
      sh mklive.sh \
      -a $ARCH \
      -o $PRO_IMG \
      -p "$PRO_PKGS $MUSL_PKGS" \
      -P "$L7PRO_PKGS" \
      -c /var/cache/xbps/
      ${REPO} "$@"
      echo "\033[1;33mFinish\033[0m"
    fi
  fi
fi
