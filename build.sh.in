#!/usr/bin/env sh
#-
# last update=488d58ff2d55e930cfa6626e181dda4c0004b052

ARCH=
IMAGE=

while getopts "a:b:hr:" opt; do
    case $opt in
        a) ARCH="$OPTARG";;
        b) IMAGE="$OPTARG";;
        h) echo "${0#/*}: [-a x86_64|x86_64-musl] [-b base|lite|studio] [-r repo]" >&2; exit 1;;
        r) REPO="-r $OPTARG $REPO";;
    esac
done
shift $((OPTIND - 1))

: ${ARCH:=$(uname -m)}

readonly DATE=$(date +%Y%m%d)
readonly GEN=$(pwgen -sA 7 1)
readonly BASE_IMG=langitketujuh-base-${ARCH}-${DATE}.iso
readonly LITE_IMG=langitketujuh-lite-${ARCH}-${DATE}.iso
readonly STD_IMG=langitketujuh-studio-${ARCH}-${DATE}.iso

# Nonfree & multilib repository
readonly REPO_NONFREE_PKGS="void-repo-nonfree"
readonly REPO_MULTILIB_PKGS="void-repo-multilib"

# Lite packages
readonly GRUB_PKGS="grub-i386-efi grub-x86_64-efi"
readonly BASE_PKGS="base-system dialog cryptsetup lvm2 mdadm"
readonly INITRD_PKGS="dracut dracut-uefi dracut-network"
readonly NETWORK_PKGS="inetutils usbutils wget curl dhcpcd wpa_supplicant NetworkManager ntp"
readonly FIRMWARE_PKGS="linux-firmware linux-firmware-intel linux-firmware-amd linux-firmware-nvidia linux-firmware-network linux-firmware-broadcom linux-firmware-qualcomm broadcom-bt-firmware b43-fwcutter alsa-firmware wifi-firmware dkms"
readonly XORG_PKGS="xorg xf86-input-evdev xf86-input-joystick xf86-input-libinput xf86-input-mtrack xf86-input-synaptics xf86-input-vmmouse xf86-input-wacom xorg-minimal xorg-input-drivers xorg-video-drivers mesa-ati-dri mesa-intel-dri mesa-nouveau-dri intel-video-accel"
readonly XORG_32_PKGS="libgcc-32bit libstdc++-32bit libdrm-32bit libglvnd-32bit mesa-dri-32bit"
readonly VULKAN_PKGS="Vulkan-Headers Vulkan-Tools Vulkan-ValidationLayers libspa-vulkan mesa-vulkan-overlay-layer vkBasalt vkd3d amdvlk"
readonly VULKAN_32_PKGS="vulkan-loader-32bit mesa-vulkan-intel-32bit mesa-vulkan-radeon-32bit"
readonly AUDIO_PKGS="alsa-utils bluez-alsa paprefs pipewire alsa-pipewire libjack-pipewire libspa-bluetooth libspa-jack libspa-v4l2 gstreamer1-pipewire pulseaudio-utils"
readonly CODEC_PKGS="gst-plugins-base1 gst-plugins-good1 gst-plugins-ugly1 gst-plugins-bad1 gst-libav ffmpeg faac faad2 flac jasper lame libdca libmpeg2 libmad libtheora libvorbis libXv wavpack x264 xvidcore gstreamer-vaapi alsa-plugins-ffmpeg phonon-qt5-backend-vlc v4l2loopback v4l-utils nv-codec-headers"
readonly COMPRESSION_PKGS="atool p7zip zip unzip lzop lzip dtrx file-roller liblz4 lz4 zlib bzip2 xz"
readonly FS_PKGS="exfat-utils gvfs-afc gvfs-mtp gvfs-smb udisks2 ntfs-3g"
readonly AUTH_PKGS="elogind dbus-elogind dbus-elogind-x11 dbus-elogind-libs polkit-elogind gnome-keyring"
readonly PRINTER_PKGS="bluez-cups cups cups-pdf cups-filters gutenprint system-config-printer system-config-printer-udev epson-inkjet-printer-escpr hplip brother-brlaser"
readonly UTILITY_PKGS="setxkbmap xauth xrandr font-misc-misc gptfdisk git inxi xtools vsv vim-huge tmate pwgen fish-shell acpilight android-udev-rules android-tools nano zenity ImageMagick libwebp libwebp-tools vpsm ufw zramen media-player-info fprintd earlyoom slop ifuse glmark2 cmake opendoas hddtemp ipmitool bind-utils tree freeipmi wmctrl lm_sensors testdisk"
readonly KDE_PKGS="xdg-utils xdg-desktop-portal xdg-desktop-portal-gtk xdg-desktop-portal-kde xdg-user-dirs xdg-user-dirs-gtk libappindicator sddm kde5 kdesu kde5-baseapps kaccounts-integration kaccounts-providers kimageformats plasma-browser-integration plasma-disks plasma-nm plasma-pa colord-kde gnome-color-manager kio-extras kio-gdrive kcm-wacomtablet plasma-wayland-protocols kdegraphics-thumbnailers ffmpegthumbnailer ffmpegthumbs ksuperkey kidentitymanagement plasma-firewall accountsservice qt5-virtualkeyboard"
readonly KDE_APPS_PKGS="konsole dolphin kdeconnect print-manager spectacle ark k3b kwalletmanager kcalc kget okular ssr kmediaplayer elisa gwenview partitionmanager vlc bup kup kamoso skanlite krfb krdc kolourpaint ktorrent kcharselect filelight gnupg2-scdaemon kgpg keepassxc"
readonly FONTS_PKGS="xorg-fonts noto-fonts-emoji unicode-emoji font-awesome5 liberation-fonts-ttf ttf-opensans amiri-font font-sil-alkalami font-sil-awami-nastaliq font-sil-harmattan font-sil-lateef font-sil-scheherazade noto-fonts-cjk"
readonly POWERMGMT_PKGS="upower acpi cpufrequtils"
readonly PKGMGMT_PKGS="topgrade flatpak"
readonly BROWSER_PKGS="firefox geckodriver"
readonly BRIGHTNESS_PKGS="brightnessctl"
readonly OFFICE_PKGS="libreoffice libreoffice-kde"
readonly APPEARANCE_PKGS="papirus-icon-theme"
readonly NOTE_PKGS="lgi xournalpp"
readonly VECTOR_PKGS="inkscape optipng fig2dev"
readonly RASTER_PKGS="gimp"

# STD Packages
readonly KDE_DESIGN_PKGS="kcolorchooser"
readonly CALLIBRATION_PKGS="lcms2 python-dbus dispcalGUI"
readonly PLUGINS_PKGS="gmic gmic-gimp gimp-lqr-plugin xsane-gimp resynthesizer inkscape-generate-palette inkscape-inx-pathops inkscape-nextgenerator"
readonly PHOTOGRAPHY_PKGS="digikam rawtherapee Converseen hugin"
readonly VIDEO_EDITOR_PKGS="kdenlive handbrake mkvtoolnix-gui"
readonly FONT_MAKER_PKGS="fontforge"
readonly PAINTING_PKGS="krita gmic-krita"
readonly RECORD_PKGS="obs screenkey"
readonly PUBLISH_PKGS="python3-tkinter scribus"
readonly TREE_D_ANIMATION_PKGS="blender"
readonly TWO_D_ANIMATION_PKGS="synfigstudio opentoonz"
readonly AUDIO_STD_PKGS="audacity ardour kid3 soundkonverter lmms freepats soundfont-fluid" #cmt alsa-plugins-jack zita-ajbridge zita-alsa-pcmi zita-at1 zita-njbridge zita-resampler alsa-plugins-samplerate calf fftw rubberband ladspa-bs2b speex mda-lv2
readonly FONTS_EXTRA_PKGS="google-fonts-ttf"
readonly GAME_PKGS="godot"
readonly CAD_PKGS="freecad LibreCAD"
readonly WINE_X86_64_MUSL_PKGS="wine wine-gecko wine-mono wine-tools winetricks protontricks"
readonly WINE_X86_64_PKGS="$REPO_MULTILIB_PKGS $WINE_X86_64_MUSL_PKGS wine-32bit"
readonly WINE_i686_PKGS="$REPO_MULTILIB_PKGS $WINE_X86_64_MUSL_PKGS"
readonly COMPILER_PKGS="automake bison fakeroot flex gdb libtool m4 patch pkg-config qemu-user-static scons yasm pkgconf gcc-objc++ xorgproto llvm clang icu cmake python3-pip"

# Arch packages
readonly X86_64_MUSL_PKGS="intel-media-driver gcompat pm-utils"
readonly X86_64_PKGS="intel-media-driver glibc-locales"
readonly I686_PKGS="glibc-locales"

# LangitKetujuh packages
readonly L7_PKGS="l7-ark l7-baloo5 l7-breeze l7-breeze-gtk l7-breeze-icons l7-desktop-file-utils l7-docs l7-export l7-fish-shell l7-gimp l7-gwenview l7-inkscape l7-kate5 l7-kcmutils l7-keepassxc l7-konsole l7-kscreenlocker l7-kservice l7-libreoffice l7-opendoas l7-papirus-icon-theme l7-pipewire l7-plasma-desktop l7-removed-packages l7-repo l7-runit-void l7-sddm l7-shadow l7-systemsettings l7-tools l7-v4l2loopback isoimagewriter runit-backlight digimend-kernel-drivers"
readonly L7_STD_PKGS="$L7_PKGS l7-ardour l7-audacity l7-godot l7-krita l7-obs l7-scribus"

# Lite basic
readonly LITE_PKGS="$REPO_NONFREE_PKGS $GRUB_PKGS $BASE_PKGS $INITRD_PKGS $NETWORK_PKGS $FIRMWARE_PKGS $XORG_PKGS $VULKAN_PKGS $UTILITY_PKGS $AUDIO_PKGS $CODEC_PKGS $COMPRESSION_PKGS $FS_PKGS $AUTH_PKGS $PRINTER_PKGS $KDE_PKGS $KDE_APPS_PKGS $FONTS_PKGS $POWERMGMT_PKGS $PKGMGMT_PKGS $BROWSER_PKGS $BRIGHTNESS_PKGS $OFFICE_PKGS $APPEARANCE_PKGS $NOTE_PKGS $VECTOR_PKGS $RASTER_PKGS"

# Lite iso edition
readonly X86_64_MUSL_LITE_PKGS="$LITE_PKGS $X86_64_MUSL_PKGS"
readonly X86_64_LITE_PKGS="$LITE_PKGS $X86_64_PKGS" #$REPO_MULTILIB_PKGS $XORG_32_PKGS $VULKAN_32_PKGS
readonly I686_LITE_PKGS="$LITE_PKGS $I686_PKGS"

# Studio basic
readonly STD_PKGS="$LITE_PKGS $KDE_DESIGN_PKGS $CALLIBRATION_PKGS $PLUGINS_PKGS $PHOTOGRAPHY_PKGS $VIDEO_EDITOR_PKGS $FONT_MAKER_PKGS $PAINTING_PKGS $RECORD_PKGS $PUBLISH_PKGS $TWO_D_ANIMATION_PKGS $AUDIO_STD_PKGS $FONTS_EXTRA_PKGS $GAME_PKGS $CAD_PKGS" #$COMPILER_PKGS

# Studio iso edition
readonly X86_64_MUSL_STD_PKGS="$STD_PKGS l7-blender $TREE_D_ANIMATION_PKGS $X86_64_MUSL_PKGS" #$WINE_X86_64_MUSL_PKGS
readonly X86_64_STD_PKGS="$STD_PKGS l7-blender $TREE_D_ANIMATION_PKGS $X86_64_PKGS" #$REPO_MULTILIB_PKGS $XORG_32_PKGS $VULKAN_32_PKGS $WINE_X86_64_PKGS
readonly I686_STD_PKGS="$STD_PKGS $I686_PKGS" #$WINE_i686_PKGS

# Iso compression
readonly INITRAMFS="gzip"
readonly SQUASHFS="gzip"

[ ! -x mklive.sh ] && exit 0

if [ -z "$IMAGE" -o "$IMAGE" = base ]; then
    if [ ! -e $BASE_IMG ]; then
        sh mklive.sh \
        -a $ARCH \
        -o $BASE_IMG \
        -p "$REPO_NONFREE_PKGS $GRUB_PKGS $BASE_PKGS $INITRD_PKGS $NETWORK_PKGS $FIRMWARE_PKGS $UTILITY_PKGS" \
        -P "l7-export l7-fish-shell l7-opendoas l7-removed-packages l7-repo l7-runit-void l7-shadow l7-tools l7-v4l2loopback runit-backlight" \
        -i $INITRAMFS \
        -s $SQUASHFS \
        ${REPO} "$@"
    fi
fi

if [ -z "$IMAGE" -o "$IMAGE" = lite ]; then
    if [ -z "$ARCH" -o "$ARCH" = x86_64-musl ]; then
        if [ ! -e $LITE_IMG ]; then
            sh mklive.sh \
            -a $ARCH \
            -o $LITE_IMG \
            -p "$X86_64_MUSL_LITE_PKGS" \
            -P "$L7_PKGS" \
            -i $INITRAMFS \
            -s $SQUASHFS \
            ${REPO} "$@"
        fi
        elif [ -z "$ARCH" -o "$ARCH" = x86_64 ]; then
        if [ ! -e $LITE_IMG ]; then
            sh mklive.sh \
            -a $ARCH \
            -o $LITE_IMG \
            -p "$X86_64_LITE_PKGS" \
            -P "$L7_PKGS" \
            -i $INITRAMFS \
            -s $SQUASHFS \
            ${REPO} "$@"
        fi
        elif [ -z "$ARCH" -o "$ARCH" = i686 ]; then
        if [ ! -e $LITE_IMG ]; then
            sh mklive.sh \
            -a $ARCH \
            -o $LITE_IMG \
            -p "$I686_LITE_PKGS" \
            -P "$L7_PKGS" \
            -i $INITRAMFS \
            -s $SQUASHFS \
            ${REPO} "$@"
        fi
    fi
fi

if [ -z "$IMAGE" -o "$IMAGE" = studio ]; then
    if [ -z "$ARCH" -o "$ARCH" = x86_64-musl ]; then
        if [ ! -e $STD_IMG ]; then
            sh mklive.sh \
            -a $ARCH \
            -o $STD_IMG \
            -p "$X86_64_MUSL_STD_PKGS" \
            -P "$L7_STD_PKGS" \
            -i $INITRAMFS \
            -s $SQUASHFS \
            ${REPO} "$@"
        fi
        elif [ -z "$ARCH" -o "$ARCH" = x86_64 ]; then
        if [ ! -e $STD_IMG ]; then
            sh mklive.sh \
            -a $ARCH \
            -o $STD_IMG \
            -p "$X86_64_STD_PKGS" \
            -P "$L7_STD_PKGS" \
            -i $INITRAMFS \
            -s $SQUASHFS \
            ${REPO} "$@"
        fi
        elif [ -z "$ARCH" -o "$ARCH" = i686 ]; then
        if [ ! -e $STD_IMG ]; then
            sh mklive.sh \
            -a $ARCH \
            -o $STD_IMG \
            -p "$I686_STD_PKGS" \
            -P "$L7_STD_PKGS" \
            -i $INITRAMFS \
            -s $SQUASHFS \
            ${REPO} "$@"
        fi
    fi
fi
