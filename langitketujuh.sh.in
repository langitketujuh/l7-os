#!/usr/bin/env sh
#-
# Copyright (c) 2020-2021 Hervy Qurrotul Ainur Rozi <hervyqa@pm.me>.
#
# All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
#
# THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
# IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
# OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
# IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
# INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
# NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
# DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
# THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
# (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
# THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#-

# Make sure we don't inherit these from env.

name=$(basename "$0")
title="LangitKetujuh OS"
version="1.1"
license="BSD 2-Clause"
locale="en_US.UTF-8"
pwd=$(pwd)

usage()
{
cat <<- EOF

builder     : $title installer
license     : $license
usage       : sudo sh $name [options]

options     : --lite-musl   -lm   # build lite musl edition
              --lite-glibc  -lg   # build lite glibc edition
              --pro-musl    -pm   # build pro musl edition
              --pro-glibc   -pg   # build pro glibc edition

              --deps-musl   -dm   # download only musl packages
              --deps-glibc  -dg   # download only glibc packages

              --help        -h    # print this help
              --version     -v    # print $name version

example     : sudo sh $name lite-musl

EOF
}

repo="void-repo-nonfree"
repo_glibc="$repo void-repo-multilib"
grub="grub-i386-efi grub-x86_64-efi"
base="base-system dialog cryptsetup lvm2 mdadm"
initrd="dracut dracut-uefi dracut-network"
network="inetutils usbutils wget curl dhcpcd wpa_supplicant NetworkManager ntp"
firmware="linux-firmware linux-firmware-intel linux-firmware-amd linux-firmware-nvidia linux-firmware-network broadcom-bt-firmware broadcom-bt-firmware b43-fwcutter alsa-firmware dkms"
xorg="xorg xf86-input-evdev xf86-input-joystick xf86-input-libinput xf86-input-mtrack xf86-input-synaptics xf86-input-vmmouse xf86-input-wacom xorg-minimal xorg-input-drivers xorg-video-drivers mesa-ati-dri mesa-intel-dri mesa-nouveau-dri"
utility="setxkbmap xauth xrandr libvdpau-va-gl vdpauinfo font-misc-misc  testdisk gptfdisk xclip xclipboard wl-clipboard yank git subversion inxi xtools vsv vim bootiso bc mtools tmate pwgen fish-shell acpilight android-udev-rules android-tools nano zenity librsvg-utils ImageMagick libwebp-tools bash-completion"
audio="alsa-plugins-pulseaudio pipewire gstreamer1-pipewire alsa-utils paprefs"
codec="gst-plugins-base1 gst-plugins-good1 gst-plugins-ugly1 gst-plugins-bad1 gst-libav ffmpeg faac faad2 flac jasper lame libdca libmpeg2 libmad libtheora libvorbis libXv wavpack x264 xvidcore gstreamer-vaapi"
compressor="atool p7zip zip unzip lzop lzip dtrx file-roller liblz4 lz4 zlib bzip2"
fs="exfat-utils fuse-exfat gvfs-afc gvfs-mtp gvfs-smb udisks2 ntfs-3g"
auth="kdesu elogind dbus-elogind dbus-elogind-x11 gnome-keyring"
compiler="automake binutils bison fakeroot flex gcc libtool m4 make patch pkg-config qemu-user-static scons yasm pkgconf libXcursor libXinerama libXi libXrandr libgudev gcc-objc++ xorgproto libfreeglut llvm clang icu"
printer="bluez-cups cups cups-pdf cups-filters gutenprint system-config-printer system-config-printer-udev hplip epson-inkjet-printer-escpr foomatic-db brother-brlaser"
de="xdg-utils xdg-desktop-portal xdg-desktop-portal-gtk xdg-desktop-portal-kde xdg-user-dirs xdg-user-dirs-gtk libappindicator AppStream sddm kde5 kdesu kde5-baseapps kaccounts-integration kaccounts-providers konsole5 dolphin dolphin-plugins kimageformats plasma-browser-integration plasma-disks plasma-nm plasma-pa colord-kde kio-extras kio-gdrive kcm-wacomtablet plasma-wayland-protocols kdegraphics-thumbnailers ffmpegthumbnailer ffmpegthumbs media-player-info ksuperkey"
apps="kdeconnect print-manager spectacle ark k3b kid3 kwalletmanager kcalc kget ktorrent okular ssr kcolorchooser kmediaplayer kaffeine elisa kolourpaint gwenview krfb krdc partitionmanager skanlite soundkonverter"
fonts="terminus-font dejavu-fonts-ttf xorg-fonts noto-fonts-emoji liberation-fonts-ttf unicode-character-database unicode-emoji font-awesome5 ttf-material-icons font-ionicons-ttf"
powermgmt="upower"
pkgmgmt="topgrade flatpak"
browser="firefox geckodriver"
vector="inkscape"
raster="gimp"
brightness="brightnessctl Clight Clightd"
callibration="python-dbus dispcalGUI"
office="libreoffice libreoffice-kde"
musl="gcompat"
glibc="glibc-locales"
#remove="kmail kontact akregator korganizer filelight konversation ytop tlp gnome-color-manager ddgtk vte3 zramen ufw"

# PRO Edition
plugins="gmic gmic-gimp gimp-lqr-plugin xsane-gimp resynthesizer"
photography="digikam rawtherapee hugin"
video_editor="kdenlive"
font_maker="fontforge"
painting="krita"
record="obs"
publish="scribus"
animation="blender synfigstudio opentoonz"
audio_pro="jack jack_capture sox audacity ardour"
fonts_extra="google-fonts-ttf"
#cad="freecad"
game="godot"
#game_win="cross-x86_64-w64-mingw32 cross-i686-w64-mingw32 python3-pip"
#game_apk="gradle android-tools openjdk"

for arg in "$@"; do
    case $arg in
        --lite-musl|-lm)
            chown root:root $pwd/includedir/lite/* -R
            make
            sh mklive.sh \
            -a x86_64-musl \
            -c $pwd/xbps-cachedir-x86_64-musl \
            -I $pwd/includedir/lite/musl \
            -l "$locale" \
            -p "$repo $grub $base $initrd $network $firmware $xorg $utility $audio $codec $compressor $fs $auth $compiler $printer $de $apps $fonts $powermgmt $browser $vector $raster $brightness $callibration $office $musl"
            echo "\033[1;33mFinish\033[0m"
            ;;
        --lite-glibc|-lg)
            chown root:root $pwd/includedir/lite/* -R
            make
            sh mklive.sh \
            -a x86_64 \
            -c $pwd/xbps-cachedir-x86_64 \
            -I $pwd/includedir/lite/glibc \
            -l "$locale" \
            -p "$repo $repo_glibc $grub $base $initrd $network $firmware $xorg $utility $audio $codec $compressor $fs $auth $compiler $printer $de $apps $fonts $powermgmt $browser $vector $raster $brightness $callibration $office $glibc"
            echo "\033[1;33mFinish\033[0m"
            ;;
        --pro-musl|-pm)
            chown root:root $pwd/includedir/pro/* -R
            make
            sh mklive.sh \
            -a x86_64-musl \
            -c $pwd/xbps-cachedir-x86_64-musl \
            -I $pwd/includedir/pro/musl \
            -l "$locale" \
            -p "$repo $grub $base $initrd $network $firmware $xorg $utility $audio $codec $compressor $fs $auth $compiler $printer $de $apps $fonts $powermgmt $browser $vector $raster $brightness $callibration $office $musl $plugins $photography $video_editor $font_maker $painting $record $publish $animation $audio_pro $fonts_extra $cad $game $game_linux $game_win $game_apk"
            echo "\033[1;33mFinish\033[0m"
            ;;
        --pro-glibc|-pg)
            chown root:root $pwd/includedir/pro/* -R
            make
            sh mklive.sh \
            -a x86_64 \
            -c $pwd/xbps-cachedir-x86_64 \
            -I $pwd/includedir/pro/glibc \
            -l "$locale" \
            -p "$repo $repo_glibc $grub $base $initrd $network $firmware $xorg $utility $audio $codec $compressor $fs $auth $compiler $printer $de $apps $fonts $powermgmt $browser $vector $raster $brightness $callibration $office $glibc $plugins $photography $video_editor $font_maker $painting $record $publish $animation $audio_pro $fonts_extra $cad $game $game_linux $game_win $game_apk"
            echo "\033[1;33mFinish\033[0m"
            ;;
        --help|-h)
            usage
            exit 0
            ;;
        --version|-v)
            echo "\033[1;33m $name\033[0m version $version"
            exit 0
            ;;
        *)
            printf "\noption does not exist: %s\n\n" "$arg"
            exit 2
    esac
done
