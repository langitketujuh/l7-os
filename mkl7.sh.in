#!/usr/bin/env sh
#-
# last update=4debf4835910fe0d4810d1248794007e7a9f5aa2

ARCH=
IMAGE=

while getopts "a:b:hr:" opt; do
    case $opt in
        a) ARCH="$OPTARG";;
        b) IMAGE="$OPTARG";;
        h) echo "${0#/*}: [-a x86_64|x86_64-musl|i686] [-b lite|studio|test] [-r repo]" >&2; exit 1;;
        r) REPO="-r $OPTARG $REPO";;
    esac
done
shift $((OPTIND - 1))

: ${ARCH:=$(uname -m)}

readonly DATE=$(date +%Y%m%d)
readonly GEN=$(pwgen -sA 7 1)
readonly LITE_IMG=langitketujuh-lite-${ARCH}-${DATE}.iso
readonly STUDIO_IMG=langitketujuh-studio-${ARCH}-${DATE}.iso
readonly TEST_IMG=langitketujuh-test-${ARCH}-${DATE}.iso
readonly INITRAMFS="gzip"
readonly SQUASHFS="gzip"

[ ! -x mklive.sh ] && exit 0

if [ -z "$IMAGE" -o "$IMAGE" = lite ]; then
    if [ -z "$ARCH" -o "$ARCH" = x86_64-musl ]; then
        if [ ! -e $LITE_IMG ]; then
            sh mklive.sh \
            -a $ARCH \
            -o $LITE_IMG \
            -p "$(grep '^[^#].' pkg/lite-x86_64-musl.packages)" \
            -R "$(grep '^[^#].' pkg/remove-list.packages)" \
            -i $INITRAMFS \
            -s $SQUASHFS \
            ${REPO} "$@"
        fi
        elif [ -z "$ARCH" -o "$ARCH" = x86_64 ]; then
        if [ ! -e $LITE_IMG ]; then
            sh mklive.sh \
            -a $ARCH \
            -o $LITE_IMG \
            -p "$(grep '^[^#].' pkg/lite-x86_64.packages)" \
            -R "$(grep '^[^#].' pkg/remove-list.packages)" \
            -i $INITRAMFS \
            -s $SQUASHFS \
            ${REPO} "$@"
        fi
        elif [ -z "$ARCH" -o "$ARCH" = i686 ]; then
        if [ ! -e $LITE_IMG ]; then
            sh mklive.sh \
            -a $ARCH \
            -o $LITE_IMG \
            -p "$(grep '^[^#].' pkg/lite-i686.packages)" \
            -R "$(grep '^[^#].' pkg/remove-list.packages)" \
            -i $INITRAMFS \
            -s $SQUASHFS \
            ${REPO} "$@"
        fi
    fi
fi

if [ -z "$IMAGE" -o "$IMAGE" = studio ]; then
    if [ -z "$ARCH" -o "$ARCH" = x86_64-musl ]; then
        if [ ! -e $STUDIO_IMG ]; then
            sh mklive.sh \
            -a $ARCH \
            -o $STUDIO_IMG \
            -p "$(grep '^[^#].' pkg/*-x86_64-musl.packages | cut -d ":" -f 2)" \
            -R "$(grep '^[^#].' pkg/remove-list.packages)" \
            -i $INITRAMFS \
            -s $SQUASHFS \
            ${REPO} "$@"
        fi
        elif [ -z "$ARCH" -o "$ARCH" = x86_64 ]; then
        if [ ! -e $STUDIO_IMG ]; then
            sh mklive.sh \
            -a $ARCH \
            -o $STUDIO_IMG \
            -p "$(grep '^[^#].' pkg/*-x86_64.packages | cut -d ":" -f 2)" \
            -R "$(grep '^[^#].' pkg/remove-list.packages)" \
            -i $INITRAMFS \
            -s $SQUASHFS \
            ${REPO} "$@"
        fi
        elif [ -z "$ARCH" -o "$ARCH" = i686 ]; then
        if [ ! -e $STUDIO_IMG ]; then
            sh mklive.sh \
            -a $ARCH \
            -o $STUDIO_IMG \
            -p "$(grep '^[^#].' pkg/*-i686.packages | cut -d ":" -f 2)" \
            -R "$(grep '^[^#].' pkg/remove-list.packages)" \
            -i $INITRAMFS \
            -s $SQUASHFS \
            ${REPO} "$@"
        fi
    fi
fi

if [ -z "$IMAGE" -o "$IMAGE" = test ]; then
    if [ -z "$ARCH" -o "$ARCH" = x86_64 ]; then
        if [ ! -e $TEST_IMG ]; then
            sh mklive.sh \
            -a $ARCH \
            -o $TEST_IMG \
            -p "$(grep '^[^#].' pkg/test-x86_64.packages)" \
            -R "$(grep '^[^#].' pkg/remove-list.packages)" \
            ${REPO} "$@"
        fi
    fi
fi
